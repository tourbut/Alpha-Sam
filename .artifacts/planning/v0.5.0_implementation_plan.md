# Goal: Portfolio Foundations & Insights (v0.5.0)

Implement historical data tracking via Transactions and Portfolio History snapshots to enable rich analytics.

## User Review Required
- **Transaction Logic**: Adding a `BUY` transaction will explicitly increase the `Position` quantity and recalculate average buy price if needed (or we just track simple weighted average). Adding a `SELL` transaction will decrease quantity.
- **Snapshot Logic**: We will trigger a `PortfolioHistory` snapshot whenever `POST /api/v1/portfolio/snapshot` is called (new endpoint) or automatically during price refresh. For this plan, we will create a dedicated endpoint for precise control.

## Proposed Changes

### Backend

#### [NEW] [transaction.py](file:///Users/shin/MyDir/MyGit/Alpha-Sam/backend/app/src/models/transaction.py)
- Model: `Transaction`
  - `id`: int
  - `asset_id`: int (FK)
  - `type`: str (BUY/SELL)
  - `quantity`: float
  - `price`: float
  - `timestamp`: datetime

#### [NEW] [portfolio_history.py](file:///Users/shin/MyDir/MyGit/Alpha-Sam/backend/app/src/models/portfolio_history.py)
- Model: `PortfolioHistory`
  - `id`: int
  - `timestamp`: datetime
  - `total_valuation`: float
  - `total_cost`: float
  - `total_profit_loss`: float

#### [MODIFY] [backend/app/src/models/__init__.py](file:///Users/shin/MyDir/MyGit/Alpha-Sam/backend/app/src/models/__init__.py)
- Export new models.

#### [NEW] [crud_transaction.py](file:///Users/shin/MyDir/MyGit/Alpha-Sam/backend/app/src/crud/crud_transaction.py)
- `create_transaction`: Records transaction AND updates `Position` (atomic transaction).
- `get_transactions`: List with pagination/filtering.

#### [MODIFY] [backend/app/src/routes/portfolio.py](file:///Users/shin/MyDir/MyGit/Alpha-Sam/backend/app/src/routes/portfolio.py)
- Add `POST /snapshot` to record current portfolio state into `PortfolioHistory`.
- Add `GET /history` to retrieve historical data for the chart.

#### [NEW] [backend/app/src/routes/transactions.py](file:///Users/shin/MyDir/MyGit/Alpha-Sam/backend/app/src/routes/transactions.py)
- `POST /`: Create transaction.
- `GET /`: List transactions.

### Frontend

#### [NEW] [src/routes/transactions/+page.svelte](file:///Users/shin/MyDir/MyGit/Alpha-Sam/frontend/src/routes/transactions/+page.svelte)
- Data Table showing transactions.
- "Add Transaction" Button calling a Modal or Form.

#### [MODIFY] [src/lib/api.ts](file:///Users/shin/MyDir/MyGit/Alpha-Sam/frontend/src/lib/api.ts)
- Add `createTransaction`, `getTransactions`, `getPortfolioHistory`.

#### [MODIFY] [src/routes/+page.svelte](file:///Users/shin/MyDir/MyGit/Alpha-Sam/frontend/src/routes/+page.svelte)
- Fetch `PortfolioHistory` data.
- Pass data to `PortfolioHistoryChart`.

#### [MODIFY] [src/lib/components/PortfolioHistoryChart.svelte](file:///Users/shin/MyDir/MyGit/Alpha-Sam/frontend/src/lib/components/PortfolioHistoryChart.svelte)
- Update to accept real data props.

## Verification Plan

### Automated Tests
- `pytest tests/crud/test_transaction.py`: Verify Position update on BUY/SELL.
- `pytest tests/api/test_portfolio.py`: Verify Snapshot creation.

### Manual Verification
1. **Transactions**:
   - Navigate to `/transactions`.
   - Add a new BUY transaction for an existing asset.
   - Verify `/positions` shows updated quantity.
   - Verify `/transactions` list shows the new entry.
2. **Dashboard**:
   - Trigger a snapshot (via API or UI button if added).
   - Check Dashboard Line Chart updates with the new data point.
