# v0.8.0 Implementation Plan - Authentication System

v0.8.0의 목표는 기존의 `X-User-Id` 헤더 기반의 임시 인증 방식을 제거하고, `FastAPI Users` 라이브러리를 활용한 견고한 JWT 인증 시스템을 구축하는 것입니다.

## User Review Required

> [!WARNING]
> **API Breaking Change**: 모든 API 요청에서 `X-User-Id` 헤더 지원이 중단됩니다. 대신 `Authorization: Bearer <token>` 헤더가 필수입니다. 클라이언트(Frontend) 및 테스트 스크립트의 전면 수정이 필요합니다.

> [!IMPORTANT]
> **Data Migration**: 기존에 생성된 자산(Asset)과 포지션(Position) 중 `owner_id`가 없는 데이터는 마이그레이션 과정에서 생성될 기본 `admin@example.com` 계정의 소유로 일괄 변경됩니다.

## Proposed Changes

### Backend (`app/`)

`FastAPI Users` 라이브러리를 도입하여 인증 로직을 표준화합니다.

#### [MODIFY] `pyproject.toml`
- `fastapi-users[sqlalchemy]` 의존성 추가.
- `passlib[bcrypt]` 등 암호화 관련 의존성 추가.

#### [NEW] `app/models/user.py`
- `SQLModel` 기반의 `User` 모델 정의 (FastAPI Users의 Base User 모델 상속).
- 필드: `email`, `hashed_password`, `is_active`, `is_superuser`, `is_verified`.

#### [NEW] `app/core/security.py`
- User Manager, UserManager 설정.
- JWT Strategy 구성 (Secret Key 관리).
- Auth Backend 설정 (Transport: Bearer, Strategy: JWT).

#### [MODIFY] `app/api/deps.py`
- `get_current_user` 의존성 주입을 `X-User-Id` 파싱 로직에서 `fastapi_users.current_user()`로 교체.

#### [MODIFY] `app/api/v1/endpoints/*.py`
- 모든 엔드포인트의 의존성을 새로운 `current_user`로 교체.

#### [NEW] `migrations/versions/xxxx_add_user_table.py`
- Alembic 마이그레이션 파일 생성.
- `User` 테이블 생성.
- 기존 데이터의 `owner_id`를 임시 디폴트 유저 ID로 업데이트하는 로직 포함.

### Frontend (`src/`)

SvelteKit Stores를 활용하여 토큰 관리 및 로그인 상태를 유지합니다.

#### [NEW] `src/lib/stores/auth.ts`
- Writable Store로 `user`, `accessToken` 상태 관리.
- LocalStorage와 연동하여 세션 유지.

#### [NEW] `src/routes/login/+page.svelte`
- 이메일/비밀번호 입력 폼.
- 로그인 성공 시 Token 저장 및 메인 페이지 리다이렉트.

#### [NEW] `src/routes/register/+page.svelte`
- 회원가입 폼.

#### [MODIFY] `src/lib/api.ts`
- API 호출 시 `X-User-Id` 헤더 제거.
- `Authorization` 헤더에 JWT 토큰 자동 삽입 로직 추가.
- 401 Unauthorized 발생 시 로그인 페이지로 강제 이동하는 Interceptor 추가.

## Verification Plan

### Automated Tests
1. **Backend Integration Tests**:
   - `pytest`
   - 회원가입 -> 로그인 -> 토큰 발급 테스트.
   - 발급된 토큰으로 `GET /assets` 호출 성공 확인.
   - 유효하지 않은 토큰으로 호출 시 401 응답 확인.
   - `X-User-Id` 헤더로 호출 시 401/403 응답 확인 (더 이상 지원하지 않음).

2. **Backend Config Validation**:
   - `SECRET_KEY` 설정 확인 및 `ALGORITHM` (HS256) 검증.

### Manual Verification
1. **Frontend Flow**:
   - 브라우저에서 `/login` 페이지 접속 확인.
   - 로그인 수행 후 LocalStorage에 `access_token` 저장 확인.
   - 로그인 상태에서 기존 대시보드 접근 및 데이터 로딩(API 호출) 정상 작동 확인.
   - 로그아웃 버튼 클릭 시 토큰 삭제 및 로그인 페이지 리다이렉트 확인.
