# v1.0.0 Backend Design: Analytics API

## Overview
This document details the design for the Analytics Engine, focusing on PnL calculation and Portfolio History.

## 1. PnL Calculation Logic (Snapshot)
**Endpoint**: `GET /api/v1/analytics/pnl`

For v1.0.0, we will use a "Simple Return" model based on currently held positions.

- **Formula**:
  - `Total Invested (Cost Basis)` = $\sum (Position.quantity \times Position.buy\_price)$
  - `Current Value` = $\sum (Position.quantity \times Current\_Market\_Price)$
  - `Unrealized PnL` = `Current Value` - `Total Invested`
  - `Return %` = $(Unrealized PnL / Total Invested) \times 100$

- **Implementation Details**:
  - Fetch all `Positions` for the user.
  - Collect `asset_id` list and fetch *current* prices (via Redis/API).
  - Compute aggregates in memory.

## 2. Portfolio History Logic (Time-Series)
**Endpoint**: `GET /api/v1/analytics/portfolio/history?period=1M`

To show a line chart of "Portfolio Value over Time".

- **Method A: Transaction Replay (Accurate)**
  1. Fetch all `Transactions` for user.
  2. Fetch `Daily Close Prices` for all assets involved for the requested period.
  3. Iterate day-by-day:
     - Determine holdings at end-of-day.
     - `Value(d) = sum(Holdings(d) * Price(d))`
  
- **Method B: Daily Snapshot (Easier, but starts from now)**
  - If we haven't stored historical snapshots, Method A is required for *past* data.
  - However, fetching historical prices for ALL assets might be slow.
  
- **Decision for v1.0.0**:
  - Use **Method A** but limit to "Last 30 Days" initially.
  - Requires `PriceService` to support `get_historical_prices(asset_id, start_date, end_date)`.

## 3. API Schema

### Response Models

```python
class PnLResponse(BaseModel):
    total_invested: float
    current_value: float
    unrealized_pnl: float
    return_percentage: float
    currency: str = "USD"

class HistoryPoint(BaseModel):
    date: date
    value: float

class HistoryResponse(BaseModel):
    period: str
    data: List[HistoryPoint]
```
