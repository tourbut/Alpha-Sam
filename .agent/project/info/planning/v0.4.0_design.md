# v0.4.0 Design Document: Portfolio Analytics & Deployment Prep

## 1. Overview
Version 0.4.0 focuses on transforming raw data into actionable insights ("Analytics") and preparing the system for a stable production release ("Deployment Prep").

## 2. Feature: Portfolio Analytics

### 2.1 Backend API Design

#### `GET /api/v1/portfolio/summary`
- **Purpose**: Provides high-level portfolio metrics and detailed per-position performance.
- **Logic**:
  1. Fetch all user's positions.
  2. For each position:
     - Get `current_price` from the latest Price entries (or external API if stale).
     - Calculate `current_value = quantity * current_price`.
     - Calculate `cost_basis = quantity * buy_price`.
     - Calculate `unrealized_pl = current_value - cost_basis`.
     - Calculate `returns_pct = (unrealized_pl / cost_basis) * 100` (handle div/0).
  3. Aggregation:
     - Sum `total_value`, `total_cost`, `total_pl`.
     - Calculate overall `total_pl_percent`.

- **Response Schema (JSON)**:
  ```json
  {
    "summary": {
      "total_value": 15000.00,
      "total_cost": 12000.00,
      "total_pl": 3000.00,
      "total_pl_stats": {
          "percent": 25.0,
          "direction": "up" // or "down"
      }
    },
    "positions": [
      {
        "id": 1,
        "symbol": "BTC",
        "quantity": 0.5,
        "current_price": 30000.00,
        "current_value": 15000.00,
        "buy_price": 24000.00,
        "unrealized_pl": 3000.00,
        "roi_percent": 25.0
      }
      // ... more positions
    ]
  }
  ```

### 2.2 Frontend Integration
- **Dashboard**:
  - Replace any static/mock "Total Balance" with `data.summary.total_value`.
  - Display "Total P/L" prominently.
- **Charts**:
  - Update "Portfolio Distribution" to use `current_value` of positions (real-time weighting) instead of just quantity or static value.

## 3. Feature: Deployment Preparation

### 3.1 Dockerization for Production
- **Objective**: Ensure the application can run in a production environment (detached, reliable).
- **Deliverables**:
  - `docker-compose.prod.yml`:
    - Should include `backend`, `frontend` (node server), and `db`.
    - Restart policy: `always`.
    - Env vars: Read from `.env.prod`.
  - `Dockerfile` optimization:
    - Backend: Ensure no dev deps.
    - Frontend: Build SvelteKit adapter-node (or static if applicable, but we have dynamic routes so adapter-node).

### 3.2 Security & Config
- **Environment Variables**:
  - Define a template `.env.prod.example`.
  - Ensure secret keys (JWT_SECRET) are not hardcoded.

## 4. Implementation Steps
1. **Backend**: Implement `PortfolioService` and `/portfolio` endpoint.
2. **Backend**: Create production docker config.
3. **Frontend**: Consume `/portfolio` endpoint on Dashboard.
