# Handovers: To Backend Developer

## 날짜
2025-12-07

## 현재 상황 (Context)
- Asset 및 Price 모델과 API는 구현 완료되었습니다.
- 하지만 **Position/Holding 모델과 API가 누락**되어 있어, 사용자가 자산을 등록해도 매수 정보(수량, 매수 단가)를 입력할 수 없습니다.
- 프론트엔드에서 수익률/평가액을 표시하려고 하지만, 백엔드에서 계산된 데이터가 없어 빈 값으로 표시됩니다.
- Redis는 docker-compose에 설정되어 있지만, 실제 캐싱 로직이 구현되지 않았습니다.

## 해야 할 일 (Tasks)
1. **Position 모델 구현**
   - 아키텍트의 설계를 참고하여 `backend/app/models/position.py` 생성.
   - Asset과의 Relationship 설정.
   - 필수 필드: `asset_id`, `quantity` (>= 0), `buy_price` (> 0), `buy_date` (선택)
   - SQLModel을 사용하여 정의.

2. **Position Schema 구현**
   - `backend/app/schemas/position.py` 생성.
   - `PositionCreate`, `PositionRead`, `PositionUpdate` 스키마 정의.
   - `PositionRead`에는 계산된 필드 포함: `valuation`, `profit_loss`, `return_rate`

3. **Position API 엔드포인트 구현**
   - `backend/app/api/endpoints/positions.py` 생성.
   - 다음 엔드포인트 구현:
     - `GET /api/v1/positions` - 포지션 목록 조회 (Asset 정보 포함)
     - `GET /api/v1/positions/{position_id}` - 특정 포지션 조회
     - `POST /api/v1/positions` - 포지션 생성 (유효성 검증: quantity >= 0, buy_price > 0)
     - `PUT /api/v1/positions/{position_id}` - 포지션 수정
     - `DELETE /api/v1/positions/{position_id}` - 포지션 삭제
   - `api_router`에 positions 라우터 등록.

4. **수익률 계산 로직 구현**
   - `backend/app/services/portfolio_service.py` 생성.
   - 다음 함수 구현:
     - `calculate_position_metrics(position, current_price)`: 단일 포지션의 평가액, 손익, 수익률 계산
     - `calculate_portfolio_summary(positions)`: 전체 포트폴리오의 총 평가액, 총 손익, 포트폴리오 수익률 계산
   - `domain_rules.md`의 계산 규칙을 정확히 따를 것:
     - 평가액 = current_price * quantity
     - 손익 = (current_price - buy_price) * quantity
     - 수익률 = ((current_price - buy_price) / buy_price) * 100
     - 포트폴리오 수익률 = 원금 가중 수익률 방식

5. **Asset API 수정**
   - `GET /api/v1/assets` 엔드포인트에서 각 Asset의 Position 정보를 포함하여 반환.
   - Position이 있으면 계산된 `valuation`, `profit_loss`, `return_rate`를 포함.
   - Position이 없으면 해당 필드는 `null`로 반환.

6. **Redis 캐싱 구현**
   - `backend/app/core/cache.py` 생성.
   - Redis 연결 설정 (환경변수 `REDIS_URL` 사용).
   - `price_service.py`에 캐싱 로직 추가:
     - 시세 조회 시 Redis에서 먼저 확인 (TTL: 5분)
     - 캐시 미스 시 외부 API 호출 후 Redis에 저장
   - `refresh_prices` API 호출 시에도 캐시 무효화 고려.

7. **Alembic 마이그레이션 생성**
   - Position 테이블을 위한 마이그레이션 파일 생성.
   - `alembic revision --autogenerate -m "add_position_table"`
   - 마이그레이션 파일 검토 후 필요시 수정.

8. **에러 처리 개선**
   - Position 생성/수정 시 유효성 검증 강화 (quantity < 0, buy_price <= 0 등).
   - 시세가 없을 때 수익률 계산을 시도하지 않도록 처리.

## 기대 산출물 (Expected Outputs)
- `backend/app/models/position.py` 파일 생성
- `backend/app/schemas/position.py` 파일 생성
- `backend/app/api/endpoints/positions.py` 파일 생성
- `backend/app/services/portfolio_service.py` 파일 생성
- `backend/app/core/cache.py` 파일 생성
- `backend/app/api/api.py`에 positions 라우터 등록
- `backend/app/services/price_service.py`에 Redis 캐싱 로직 추가
- `backend/app/api/endpoints/assets.py`에서 Position 정보 포함하여 반환
- Alembic 마이그레이션 파일 생성 및 적용 가능한 상태
- API 문서 (FastAPI 자동 생성)에서 Position 엔드포인트 확인 가능

## 참고 자료 (References)
- `.artifacts/prompts/projects/alphha_sam/domain_rules.md` (수익률 계산 규칙, Position 필드 규칙)
- `.artifacts/prompts/projects/alphha_sam/tech_stack.md` (Redis, SQLModel 사용법)
- `backend/app/models/asset.py` (기존 모델 구조 참고)
- `backend/app/api/endpoints/assets.py` (기존 API 구조 참고)

## 완료 상태
✅ 모든 작업 완료 (2025-12-07)

### 완료된 작업 내역

1. ✅ **Position 모델 구현**
   - `backend/app/models/position.py` 생성 완료
   - Asset과의 Relationship 설정 완료
   - DB 레벨 CheckConstraint로 유효성 검증 구현
   - `backend/app/models/asset.py`에 positions relationship 추가

2. ✅ **Position Schema 구현**
   - `backend/app/schemas/position.py` 생성 완료
   - `PositionCreate`, `PositionRead`, `PositionUpdate`, `PositionWithAsset` 스키마 정의
   - 계산된 필드 포함: `valuation`, `profit_loss`, `return_rate`, `current_price`

3. ✅ **Position API 엔드포인트 구현**
   - `backend/app/api/endpoints/positions.py` 생성 완료
   - 모든 CRUD 엔드포인트 구현 완료
   - `backend/app/api/api.py`에 positions 라우터 등록 완료

4. ✅ **수익률 계산 로직 구현**
   - `backend/app/services/portfolio_service.py` 생성 완료
   - `calculate_position_metrics()` 함수 구현 (단일 포지션 계산)
   - `calculate_portfolio_summary()` 함수 구현 (전체 포트폴리오 계산)
   - `domain_rules.md`의 계산 규칙 정확히 준수

5. ✅ **Asset API 수정**
   - `GET /api/v1/assets` 엔드포인트에서 Position 정보 포함
   - Position이 있으면 계산된 메트릭 포함
   - 시세가 없을 때도 안전하게 처리

6. ✅ **Redis 캐싱 구현**
   - `backend/app/core/cache.py` 생성 완료
   - Redis 연결 설정 완료 (환경변수 `REDIS_URL` 사용)
   - `price_service.py`에 캐싱 로직 추가 (TTL: 5분)
   - `refresh_prices` API 호출 시 캐시 무효화 구현
   - 애플리케이션 종료 시 Redis 연결 정리
   - `pyproject.toml`에 redis, hiredis 의존성 추가

7. ✅ **Alembic 마이그레이션 생성**
   - `alembic revision --autogenerate -m "add_position_table"` 실행 완료
   - 마이그레이션 파일 생성: `23c0c0915d12_add_position_table.py`
   - CheckConstraint 포함 확인

8. ✅ **에러 처리 개선**
   - Position 생성/수정 시 유효성 검증 강화
   - 시세가 없을 때 수익률 계산 시도하지 않음 (None 반환)
   - Asset이 삭제된 경우에도 Position 정보 반환 가능
   - 명확한 에러 메시지 제공
   - 0으로 나누기 방지 처리

### 생성/수정된 파일 목록

**새로 생성된 파일:**
- `backend/app/models/position.py`
- `backend/app/schemas/position.py`
- `backend/app/api/endpoints/positions.py`
- `backend/app/services/portfolio_service.py`
- `backend/app/core/cache.py`
- `backend/alembic/versions/23c0c0915d12_add_position_table.py`

**수정된 파일:**
- `backend/app/models/asset.py` (positions relationship 추가)
- `backend/app/models/__init__.py` (Position import 추가)
- `backend/app/schemas/asset.py` (계산된 필드 추가)
- `backend/app/api/endpoints/assets.py` (Position 정보 포함)
- `backend/app/api/endpoints/prices.py` (캐시 무효화 추가)
- `backend/app/api/api.py` (positions 라우터 등록)
- `backend/app/services/price_service.py` (Redis 캐싱 추가)
- `backend/app/main.py` (Position import, Redis 종료 처리)
- `backend/pyproject.toml` (redis, hiredis 의존성 추가)


