# v1.1.0 Architecture Draft: Social & Automation

## 1. Overview
v1.1.0 aims to introduce **Social interactions** (sharing portfolios, leaderboards) and **Automation** (rebalancing alerts, paper trading). This document outlines the architectural changes required.

## 2. Social Features
### 2.1. Shared Portfolios
- **Requirement**: Users can generate a public link to share their portfolio performance.
- **Privacy**: Access control (Public/Private/Link-only).
- **Schema Changes**:
  - `PortfolioShare` (New Entity)
    - `id` (UUID): Unique link identifier.
    - `user_id` (FK): Owner.
    - `is_active` (Boolean): Enabled/Disabled.
    - `settings` (JSON): e.g., `{ "show_amounts": false, "show_pnl": true }`.
    - `created_at` / `expires_at`.

### 2.2. Leaderboard
- **Requirement**: Global ranking based on PnL%.
- **Implementation**:
  - **Calculation**: Background job (Celery) calculates Daily/Weekly PnL% for all opt-in users.
  - **Storage**: Redis Sorted Sets (`ZADD leaderboard:weekly <score> <user_id>`).
  - **Performance**: Fetch top 100 from Redis (O(log(N))).
- **Schema Changes**:
  - `UserProfile` (Extension):
    - `is_public_leaderboard` (Boolean): Opt-in flag.

## 3. Automation Features
### 3.1. Auto-Rebalancing Alerts
- **Requirement**: Notify when actual allocation deviates from target by X%.
- **Architecture**:
  - **Target Allocation Entity**:
    - `RebalancingTarget`: `user_id`, `asset_id`, `target_percent`.
  - **Trigger**:
    - Price Update Event -> Calculate deviation -> If > threshold -> Send Alert.
  - **Logic**: Reuse existing Notification infrastructure (Celery + Redis debouncing).

### 3.2. Paper Trading Bot Integration
- **Requirement**: Automated trading simulation.
- **Architecture**:
  - **Bot Service (Separate Class/Module)**:
    - `TradingBot`: Stateless strategy executor.
    - `Strategy`: Interface (`should_buy`, `should_sell`).
  - **Execution Loop**:
    - Scheduled Task (e.g., every 5 mins).
    - Fetch Market Data -> Run Strategy -> Create `Transaction` (Paper).
  - **State**:
    - `BotInstance`: `user_id`, `strategy_name`, `status` (Running/Paused), `config` (JSON).

## 4. Tech Debt & Scalability
- **Database**:
  - Add indexes on `Transaction.created_at` for faster PnL calculation ranges.
- **Caching**:
  - Cache public portfolio views to reduce DB load.

## 5. Implementation Phases
1.  **Phase 1 (Social)**: DB Migration (Share/Leaderboard), API endpoints.
2.  **Phase 2 (Automation)**: Bot Logic, Scheduled Tasks.
