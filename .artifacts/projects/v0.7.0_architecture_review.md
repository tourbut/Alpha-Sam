# Architecture Review: v0.7.0 Notification System

## 1. 개요
v0.7.0에 구현된 `NotificationSettings` 및 Celery 기반 알림 시스템에 대한 아키텍처 점검 결과입니다.

## 2. 주요 점검 사항

### 2.1 확장성 (Scalability) - [WARNING]
현재 `daily_portfolio_report_job`의 구현 방식에 확장성 한계가 발견되었습니다.
- **문제점**: `_process_daily_reports` 함수가 단일 프로세스에서 모든 활성 유저를 루프 돌며 처리합니다. 유저 수(N)와 포지션 수(M)에 따라 쿼리 횟수가 `O(N*M)`으로 증가하여 실행 시간이 급격히 늘어날 수 있습니다.
- **권장 개선안**:
  1. **Bulk Query**: 유저 루프 밖에서 필요한 `Price` 데이터를 한 번에 Fetch하도록 변경.
  2. **Celery Chunks**: 유저 목록을 일정 크기로 나누어 병렬 Task로 발행 (Job 분산).
  3. **Eager Loading**: `users` 조회 시 `NotificationSettings`를 `join`으로 함께 로드하도록 수정.

### 2.2 데이터 무결성
- **NotificationSettings 자동 생성**: 현재는 태스크 수행 시 설정이 없으면 기본값을 사용하지만, 유저 생성 시점에 `NotificationSettings`가 생성되도록 `SQLAlchemy` 이벤트를 사용하거나 `UserManager`에서 처리하는 것이 더 견고합니다.

### 2.3 알림 트리거 로킹 (Rate Limiting)
- 가격 알림 시 Redis Key를 활용한 1일 1회 발송 제한 로직이 계획되어 있습니다. 이는 중복 알림을 방지하는 좋은 설계입니다. 단, 대규모 가격 변동 시 수많은 Task가 동시에 발행될 수 있으므로 Worker의 동시성(Concurrency) 조절이 필요합니다.

## 3. 결론
현재의 구조는 MVP 및 중소규모 유저 수준에서는 충분히 작동하나, 정식 런칭 전 위에서 언급한 **Task 분산 처리(Batching/Chunking)** 로직 보강이 필요합니다.
