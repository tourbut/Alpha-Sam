# Alpha-Sam v1.1.0 Architecture Design: Social Features

## 1. Overview
v1.1.0의 목표는 사용자가 자신의 포트폴리오를 타인과 공유하고, 성과를 경쟁할 수 있는 소셜 기능을 도입하는 것입니다.

### Key Features
1. **Portfolio Sharing**: 포트폴리오 공개 범위 설정 및 공유 링크 생성.
2. **Leaderboard**: 수익률 기반 사용자 랭킹 시스템.
3. **Social Graph**: 팔로우/팔로잉 관계.

## 2. Data Modeling

### 2.1 Portfolio Sharing (Extension of Portfolio)
기존 `Portfolio` 모델에 공유 설정을 추가합니다.

- **Attributes**:
  - `visibility`: Enum (`PRIVATE`, `PUBLIC`, `LINK_ONLY`). Default `PRIVATE`.
  - `share_token`: UUID (Unique, Nullable). `LINK_ONLY` 모드에서 사용.
  - `is_primary_for_leaderboard`: Boolean. 리더보드 집계 대상인지 여부.

### 2.2 Social Profile
사용자의 소셜 활동을 위한 프로필 정보.

- **Entity**: `UserProfile` (or extend `User`)
- **Attributes**:
  - `bio`: 자기소개 (Text).
  - `website`: 개인 웹사이트 URL (Optional).
  - `social_links`: JSON (Twitter, GitHub etc).
  - `leaderboard_opt_in`: Boolean. 리더보드 참여 여부.

### 2.3 Follow System
- **Entity**: `UserFollow`
- **Attributes**:
  - `follower_id`: FK -> User.
  - `following_id`: FK -> User.
  - `created_at`: Timestamp.

### 2.4 Leaderboard Entry (Snapshot)
리더보드 집계를 위한 스냅샷 테이블 (Performance Optimization).
배치 작업(Celery)을 통해 주기적으로 갱신합니다.

- **Entity**: `LeaderboardRank`
- **Attributes**:
  - `user_id`: FK -> User.
  - `portfolio_id`: FK -> Portfolio.
  - `period`: Enum (`DAILY`, `WEEKLY`, `ALL_TIME`).
  - `return_rate`: 수익률 (Float).
  - `rank`: 순위 (Integer).
  - `updated_at`: Timestamp.

## 3. API Specification

### 3.1 Portfolio Operations
- `PATCH /api/v1/portfolios/{id}/visibility`: 공개 범위 변경 (Private/Public/Link).
- `GET /api/v1/portfolios/shared/{token}`: 공유 링크로 포트폴리오 조회 (Auth Optional).

### 3.2 Social Actions
- `POST /api/v1/social/follow/{user_id}`: 팔로우.
- `DELETE /api/v1/social/follow/{user_id}`: 언팔로우.
- `GET /api/v1/social/users/{user_id}/profile`: 프로필 조회.
- `GET /api/v1/social/users/{user_id}/followers`: 팔로워 목록.
- `GET /api/v1/social/users/{user_id}/following`: 팔로잉 목록.

### 3.3 Leaderboard
- `GET /api/v1/social/leaderboard?period=weekly`: 리더보드 조회 (Paging support).

## 4. Technical Decisions

### 4.1 Leaderboard Calculation
- **Issue**: 실시간 수익률 계산은 DB 부하가 큼.
- **Solution**:
  - **Batch Processing**: Celery Beat를 사용하여 1시간(또는 하루) 간격으로 수익률 계산 후 `LeaderboardRank` 테이블 갱신.
  - **Caching**: 조회 API는 Redis 캐싱 적용 (TTL 10분).

### 4.2 Privacy
- `LINK_ONLY` 포트폴리오는 UUID 토큰이 있어야만 접근 가능.
- `PRIVATE` 포트폴리오는 오직 소유자만 접근 가능.
- 리더보드에는 `leaderboard_opt_in = True`인 유저만 노출.

## 5. Security & Validation
- 타인의 `PRIVATE` 포트폴리오 접근 시도 시 404 또는 403 반환.
- `PUBLIC` 포트폴리오라도 민감한 정보(정확한 매수/매도 시점 등)는 마스킹 처리 고려 (Phase 2). v1.1.0에서는 전체 공개.
