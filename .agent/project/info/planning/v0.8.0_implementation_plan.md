# v0.8.0 Implementation Plan: Authentication

## 1. Goal
- `X-User-Id` 헤더 기반의 개발용 인증 방식을 제거하고, `fastapi-users` 라이브러리를 도입하여 표준 JWT 인증 시스템을 구축한다.
- 기존 v0.7.0의 User 모델과 호환성을 유지하며, 안전하고 확장 가능한 인증/인가 구조를 만든다.

## 2. Dependencies
- **Add**: `fastapi-users[sqlalchemy]`
- **Remove** (or Deprecate): Manual JWT implementation in `security.py` (optional, can be kept for utility but auth flow changes).

## 3. Architecture Changes

### A. Database Schema (User Model)
- **File**: `backend/app/src/models/user.py`
- **Change**: `User` 클래스가 `fastapi_users_db_sqlmodel.SQLModelBaseUserDB`를 상속받거나, 필요한 필드(`email`, `hashed_password`, `is_active`, `is_superuser`, `is_verified`)를 명시적으로 호환되게 정의.
- **Migration**: 기존 `users` 테이블에 `is_verified` 컬럼 추가 필요 (FastAPI Users 기본 요구사항).

### B. Authentication Core
- **File**: `backend/app/src/core/auth.py` (New)
- **Components**:
  - `get_user_db`: SQLModel User Adapter.
  - `UserManager`: 사용자 관리 로직 (Registration, Verification, Password Reset).
  - `Auth Backend`: Bearer Token Transport + JWT Strategy.
  - `fastapi_users`: FastAPIUsers 인스턴스 생성.

### C. Dependency Injection
- **File**: `backend/app/src/deps.py`
- **Change**:
  - Remove `get_current_user` logic that checks `X-User-Id`.
  - Replace with `fastapi_users.current_user(active=True)`.
  - 기존 `X-User-Id` 의존 코드를 모두 제거하고, `User` 객체를 `request.state`나 Dependency로 주입받도록 리팩토링.

### D. API Routes
- **File**: `backend/app/src/routes/auth.py` (or `api.py`)
- **Change**:
  - Register `fastapi_users.get_auth_router` (Login/Logout).
  - Register `fastapi_users.get_register_router` (Signup).
  - Register `fastapi_users.get_users_router` (User Profile).

## 4. Migration Strategy

### 1. Library Installation
```bash
uv add "fastapi-users[sqlalchemy]"
```

### 2. DB Migration (Alembic)
- `User` 모델 변경(`is_verified` 추가 등)을 반영하는 Migration file 생성.
- 기존 사용자의 `is_verified` 값을 `True`로 설정 (Migration Script).

### 3. Code Refactoring via Strategy pattern
- `feature/arch-v0.8.0-planning` 브랜치에서 계획 수립 후, `feature/auth-implementation` 브랜치에서 단계적 적용.

## 5. Verification Plan

### Automated Tests
- **Auth Flow**: `/auth/register`, `/auth/login` 성공 여부 확인.
- **Protected Route**: `/users/me` 접근 시 토큰 필요성 검증.
- **Permissions**: `superuser` 전용 API 접근 제어 확인.

### Manual Verification
- Swagger UI를 통해 회원가입 -> 로그인 -> Access Token 발급 확인.
- 발급된 토큰으로 기존 포트폴리오 API 호출 시 `owner_id`가 정상 식별되는지 확인.
