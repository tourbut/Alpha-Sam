# v0.9.0 Implementation Plan - Data Migration & Optimization

This plan outlines the steps for Alpha-Sam v0.9.0, focusing on securing data integrity for legacy records and optimizing database performance.

## User Review Required
> [!IMPORTANT]
> **Data Ownership Decision**: All legacy `positions` with `owner_id IS NULL` will be assigned to **User ID 1** (assumed to be the default Admin). Please confirm this policy is acceptable. Legacy `assets` will remain with `owner_id IS NULL` (Global Assets).

## Proposed Changes

### Data Migration (Legacy Data)
#### [NEW] [scripts/migrate_v090_legacy_data.py](file:///Users/shin/MyDir/MyGit/Alpha-Sam/backend/scripts/migrate_v090_legacy_data.py)
- A standalone script to be run **before** fully enforcing `NOT NULL` constraints in production (though Alembic might have already tried, we ensure data cleanliness).
- **Logic**:
  1. Check if `positions` table has rows with `owner_id IS NULL`.
  2. If found, update them to `owner_id = 1` (Admin).
  3. Validate that `assets` with `owner_id IS NULL` are treated as Global.
  4. Log the number of affected rows.

### Backend Optimization
#### [MODIFY] [backend/app/src/routes/portfolio.py](file:///Users/shin/MyDir/MyGit/Alpha-Sam/backend/app/src/routes/portfolio.py)
- **Fix N+1 Query in `create_portfolio_snapshot`**:
  - Unoptimized: Currently loops through positions and executes a `SELECT FROM prices` query for each position.
  - Optimized: Fetch all latest prices for the relevant assets in a **single query** (using `IN` clause or `DISTINCT ON`), similar to `get_portfolio_summary`.

### Domain Documentation
#### [MODIFY] [.artifacts/projects/domain_rules.md](file:///Users/shin/MyDir/MyGit/Alpha-Sam/.artifacts/projects/domain_rules.md)
- Explicitly document the "Global vs Custom" asset ownership rule.
- Explicitly document that `positions` MUST belong to a user.

## Verification Plan

### Automated Tests
- **Migration Test**:
  - [x] Run `python backend/scripts/migrate_v090_legacy_data.py` in a test environment with seeded legacy data (NULL owner_id).
  - [x] Assert that no positions remain with NULL owner_id.
  - **Result**: Checked and Passed by QA (`.artifacts/projects/qa_reports/test_report_v0.9.0.md`).
- **Portfiolio Snapshot Test**:
  - [x] Run existing `tests/qa_auth_api.py` (or creating a specific perf test) to ensure `POST /portfolio/snapshot` returns 201 and creates history correctly.
  - [x] (Optional) Measure query count before/after using a profiler or log inspection.
  - **Result**: API response time 0.02s verified.

### Manual Verification
- **Admin Check**:
  - [x] Login as Admin (User 1).
  - [x] Verify that "lost" positions (legacy) now appear in Admin's portfolio.
  - **Result**: Verified via Dirty Data Simulation.

