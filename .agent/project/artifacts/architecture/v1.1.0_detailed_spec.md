# Alpha-Sam v1.1.0 상세 설계 명세서

> 작성일: 2026-01-16  
> 작성자: Architect  
> 참조: `v1.1.0_design_draft.md`, `domain_rules.md`, `tech_stack.md`

---

## 1. 개요 (Overview)

v1.1.0은 **소셜 기능(Social Features)**을 도입하여 사용자 간 포트폴리오 공유 및 성과 경쟁을 가능하게 합니다.

### 핵심 기능 요약
| 기능 | 설명 | 우선순위 |
|------|------|----------|
| **Portfolio Sharing** | 포트폴리오 공개 범위 설정 및 공유 링크 생성 | P0 |
| **Leaderboard** | 수익률 기반 주간/일간 랭킹 시스템 | P0 |
| **Social Graph** | 사용자 팔로우/팔로잉 관계 | P1 |
| **User Profile** | 소셜 활동을 위한 프로필 정보 | P1 |

---

## 2. 데이터베이스 스키마 (Database Schema)

### 2.1 Portfolio 테이블 확장

기존 `Portfolio` 테이블에 다음 필드를 추가합니다.

#### Alembic 마이그레이션 계획

```python
# alembic/versions/xxxx_add_social_fields_to_portfolio.py
"""add social fields to portfolio

Revision ID: xxxx
Revises: [previous_revision]
Create Date: 2026-01-XX
"""

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

def upgrade():
    # visibility 컬럼 추가: 기본값 PRIVATE
    op.add_column('portfolios', 
        sa.Column('visibility', 
                  sa.Enum('PRIVATE', 'PUBLIC', 'LINK_ONLY', name='portfolio_visibility'),
                  nullable=False,
                  server_default='PRIVATE'))
    
    # share_token 컬럼 추가: LINK_ONLY 모드에서 사용
    op.add_column('portfolios',
        sa.Column('share_token', postgresql.UUID(as_uuid=True), nullable=True))
    
    # 리더보드 집계 대상 여부
    op.add_column('portfolios',
        sa.Column('is_primary_for_leaderboard', sa.Boolean(), nullable=False, server_default='false'))
    
    # share_token에 유니크 인덱스 생성
    op.create_index('ix_portfolios_share_token', 'portfolios', ['share_token'], unique=True)

def downgrade():
    op.drop_index('ix_portfolios_share_token', table_name='portfolios')
    op.drop_column('portfolios', 'is_primary_for_leaderboard')
    op.drop_column('portfolios', 'share_token')
    op.drop_column('portfolios', 'visibility')
    sa.Enum(name='portfolio_visibility').drop(op.get_bind())
```

#### 테이블 스키마

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| `visibility` | ENUM | NOT NULL, DEFAULT 'PRIVATE' | 공개 범위 |
| `share_token` | UUID | UNIQUE, NULLABLE | 공유 링크 토큰 |
| `is_primary_for_leaderboard` | BOOLEAN | NOT NULL, DEFAULT FALSE | 리더보드 대표 포트폴리오 |

---

### 2.2 UserFollow 테이블 (신규)

사용자 간 팔로우 관계를 저장합니다.

```python
# app/models/social.py
class UserFollow(SQLModel, table=True):
    """사용자 팔로우 관계 테이블"""
    __tablename__ = "user_follows"
    
    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    follower_id: uuid.UUID = Field(foreign_key="user.id", nullable=False, index=True)
    following_id: uuid.UUID = Field(foreign_key="user.id", nullable=False, index=True)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    
    __table_args__ = (
        # 동일한 팔로우 관계 중복 방지
        UniqueConstraint('follower_id', 'following_id', name='uq_user_follow'),
        # Self-follow 방지는 애플리케이션 레벨에서 검증
    )
```

#### 테이블 스키마

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| `id` | UUID | PK | 기본 키 |
| `follower_id` | UUID | FK(user.id), NOT NULL, INDEX | 팔로워 사용자 |
| `following_id` | UUID | FK(user.id), NOT NULL, INDEX | 팔로잉 대상 사용자 |
| `created_at` | TIMESTAMP | NOT NULL | 팔로우 시점 |

#### 제약조건
- `UNIQUE(follower_id, following_id)`: 중복 팔로우 방지
- Application-level: `follower_id != following_id` (Self-follow 금지)

---

### 2.3 LeaderboardRank 테이블 (신규)

Celery 배치 작업을 통해 주기적으로 갱신되는 랭킹 스냅샷 테이블입니다.

```python
# app/models/social.py
class LeaderboardPeriod(str, Enum):
    DAILY = "daily"
    WEEKLY = "weekly"
    ALL_TIME = "all_time"

class LeaderboardRank(SQLModel, table=True):
    """리더보드 랭킹 스냅샷 테이블"""
    __tablename__ = "leaderboard_ranks"
    
    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    user_id: uuid.UUID = Field(foreign_key="user.id", nullable=False, index=True)
    portfolio_id: uuid.UUID = Field(foreign_key="portfolios.id", nullable=False)
    period: LeaderboardPeriod = Field(nullable=False, index=True)
    return_rate: float = Field(nullable=False)  # 수익률 (소수점, 예: 0.15 = 15%)
    rank: int = Field(nullable=False)           # 순위 (1부터 시작)
    total_value: float = Field(nullable=True)   # 총 평가금액 (선택)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
    
    __table_args__ = (
        # 동일 기간에 유저당 하나의 랭킹만 존재
        UniqueConstraint('user_id', 'period', name='uq_leaderboard_user_period'),
    )
```

#### 테이블 스키마

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| `id` | UUID | PK | 기본 키 |
| `user_id` | UUID | FK(user.id), NOT NULL, INDEX | 사용자 |
| `portfolio_id` | UUID | FK(portfolios.id), NOT NULL | 대표 포트폴리오 |
| `period` | ENUM | NOT NULL, INDEX | 집계 기간 (daily/weekly/all_time) |
| `return_rate` | FLOAT | NOT NULL | 수익률 |
| `rank` | INTEGER | NOT NULL | 순위 |
| `total_value` | FLOAT | NULLABLE | 총 평가금액 |
| `updated_at` | TIMESTAMP | NOT NULL | 갱신 시점 |

---

### 2.4 UserProfile 테이블 확장 (선택)

User 테이블에 소셜 프로필 필드를 추가하거나, 별도 테이블로 분리할 수 있습니다.

> [!NOTE]
> v1.1.0에서는 기존 User 테이블의 `nickname` 필드를 활용하고, 추가 프로필 정보(bio, social_links 등)는 Phase 2로 연기합니다.

---

## 3. API 명세 (API Specification)

### 3.1 Portfolio Visibility API

#### PATCH `/api/v1/portfolios/{portfolio_id}/visibility`

포트폴리오 공개 범위를 변경합니다.

**Request Body**
```json
{
  "visibility": "PUBLIC" | "PRIVATE" | "LINK_ONLY"
}
```

**Response (200 OK)**
```json
{
  "id": "uuid",
  "name": "string",
  "visibility": "PUBLIC",
  "share_token": "uuid | null",
  "share_url": "https://alpha-sam.com/shared/abc123 | null"
}
```

**비즈니스 로직**
1. `visibility`가 `LINK_ONLY`로 변경되면 `share_token`을 자동 생성 (UUID v4)
2. `visibility`가 `PRIVATE`로 변경되면 `share_token`을 NULL로 초기화
3. 소유자만 변경 가능 (403 Forbidden)

---

#### GET `/api/v1/portfolios/shared/{share_token}`

공유 링크를 통해 포트폴리오를 조회합니다. 인증 선택적.

**Response (200 OK)**
```json
{
  "portfolio": {
    "id": "uuid",
    "name": "string",
    "owner_nickname": "string",
    "total_value": 15000.50,
    "return_rate": 0.12,
    "positions": [
      {
        "asset_symbol": "BTC",
        "asset_name": "Bitcoin",
        "quantity": 0.5,
        "current_value": 10000.00,
        "pnl_percent": 0.25
      }
    ]
  },
  "visibility": "LINK_ONLY"
}
```

**에러 처리**
- `404 Not Found`: 토큰이 존재하지 않거나 만료됨
- `403 Forbidden`: PRIVATE 포트폴리오에 대한 접근 시도

---

### 3.2 Social Follow API

#### POST `/api/v1/social/follow/{user_id}`

사용자를 팔로우합니다.

**Response (201 Created)**
```json
{
  "following_id": "uuid",
  "following_nickname": "string",
  "created_at": "2026-01-16T12:00:00Z"
}
```

**에러 처리**
- `400 Bad Request`: Self-follow 시도
- `409 Conflict`: 이미 팔로우 중

---

#### DELETE `/api/v1/social/follow/{user_id}`

사용자를 언팔로우합니다.

**Response (204 No Content)**

**에러 처리**
- `404 Not Found`: 팔로우 관계가 존재하지 않음

---

#### GET `/api/v1/social/users/{user_id}/followers`

사용자의 팔로워 목록을 조회합니다.

**Query Parameters**
| 파라미터 | 타입 | 기본값 | 설명 |
|----------|------|--------|------|
| `page` | int | 1 | 페이지 번호 |
| `limit` | int | 20 | 페이지당 개수 (최대 100) |

**Response (200 OK)**
```json
{
  "items": [
    {
      "user_id": "uuid",
      "nickname": "string",
      "followed_at": "2026-01-15T10:00:00Z"
    }
  ],
  "total": 150,
  "page": 1,
  "limit": 20,
  "has_next": true
}
```

---

#### GET `/api/v1/social/users/{user_id}/following`

사용자가 팔로잉하는 목록을 조회합니다. (구조 동일)

---

### 3.3 Leaderboard API

#### GET `/api/v1/social/leaderboard`

리더보드를 조회합니다.

**Query Parameters**
| 파라미터 | 타입 | 기본값 | 설명 |
|----------|------|--------|------|
| `period` | string | `weekly` | 집계 기간 (daily, weekly, all_time) |
| `page` | int | 1 | 페이지 번호 |
| `limit` | int | 50 | 페이지당 개수 (최대 100) |

**Response (200 OK)**
```json
{
  "period": "weekly",
  "updated_at": "2026-01-16T00:00:00Z",
  "rankings": [
    {
      "rank": 1,
      "user_id": "uuid",
      "nickname": "TopTrader",
      "return_rate": 0.35,
      "return_rate_display": "+35.00%"
    },
    {
      "rank": 2,
      "user_id": "uuid",
      "nickname": "CryptoKing",
      "return_rate": 0.28,
      "return_rate_display": "+28.00%"
    }
  ],
  "total": 500,
  "page": 1,
  "limit": 50,
  "has_next": true
}
```

**캐싱 전략**
- Redis 캐시 적용: Key `leaderboard:{period}:page:{page}`
- TTL: 10분
- 갱신: Celery Beat가 1시간마다 재계산 후 캐시 무효화

---

## 4. Leaderboard 알고리즘 설계

### 4.1 수익률 산정 방식

**주간 수익률 계산 공식**

```
weekly_return_rate = (현재_평가금액 - 7일전_평가금액) / 7일전_평가금액
```

**구현 세부사항**
1. **기준 시점**: 매주 월요일 00:00 UTC
2. **평가금액 스냅샷**: 배치 작업 시점의 Position 합계 × 현재 시세
3. **신규 사용자 처리**: 7일 미만 히스토리가 있는 경우, 첫 거래일 기준으로 계산
4. **거래 없는 경우**: 기존 Position 기반으로 시세 변동만 반영

### 4.2 Celery 배치 작업 설계

```python
# app/tasks/leaderboard.py
from celery import Celery
from celery.schedules import crontab

celery_app = Celery('alpha_sam')

@celery_app.task
def calculate_weekly_leaderboard():
    """
    주간 리더보드 계산 배치
    - 실행 주기: 매시간 (정각)
    - 대상: is_primary_for_leaderboard=True인 포트폴리오
    """
    # 1. opt-in 유저의 primary 포트폴리오 조회
    # 2. 각 포트폴리오의 수익률 계산
    # 3. 순위 정렬 후 LeaderboardRank 테이블 UPSERT
    # 4. Redis 캐시 무효화
    pass

celery_app.conf.beat_schedule = {
    'calculate-weekly-leaderboard': {
        'task': 'app.tasks.leaderboard.calculate_weekly_leaderboard',
        'schedule': crontab(minute=0),  # 매시간 정각
    },
}
```

### 4.3 성능 최적화

| 전략 | 설명 |
|------|------|
| **스냅샷 테이블** | 실시간 계산 대신 사전 계산된 LeaderboardRank 테이블 조회 |
| **Redis 캐싱** | 조회 API는 Redis에서 먼저 조회 (TTL 10분) |
| **Pagination** | 전체 랭킹 대신 페이지 단위 조회 |
| **Opt-in 필터** | 리더보드 참여 동의한 유저만 계산 대상 |

---

## 5. 보안 및 검증 (Security & Validation)

### 5.1 접근 제어 규칙

| 시나리오 | 응답 |
|----------|------|
| 타인의 PRIVATE 포트폴리오 접근 | `403 Forbidden` |
| 존재하지 않는 share_token | `404 Not Found` |
| Self-follow 시도 | `400 Bad Request` |
| 중복 팔로우 | `409 Conflict` |

### 5.2 데이터 마스킹 (Phase 2)

> [!IMPORTANT]
> v1.1.0에서는 PUBLIC 포트폴리오의 모든 정보를 공개합니다.  
> Phase 2에서 민감한 정보(정확한 매수/매도 시점, 수량) 마스킹을 구현할 예정입니다.

---

## 6. 프론트엔드 요구사항

### 6.1 신규 페이지

| 페이지 | 경로 | 설명 |
|--------|------|------|
| 리더보드 | `/leaderboard` | 주간/일간 랭킹 조회 |
| 공유 포트폴리오 | `/shared/{token}` | 공유 링크를 통한 포트폴리오 조회 |
| 사용자 프로필 | `/users/{id}` | 팔로우/팔로잉 목록, 공개 포트폴리오 |

### 6.2 기존 페이지 수정

| 페이지 | 변경 사항 |
|--------|-----------|
| 포트폴리오 상세 | 공유 설정 모달 추가 (visibility 변경, 공유 링크 복사) |
| 대시보드 | 팔로잉 사용자의 최근 활동 위젯 (Phase 2) |

---

## 7. 검증 계획 (Verification Plan)

### 7.1 자동화 테스트

```bash
# 백엔드 단위 테스트
cd backend && uv run pytest tests/test_social.py -v

# 백엔드 통합 테스트
cd backend && uv run pytest tests/integration/test_leaderboard.py -v
```

### 7.2 QA 테스트 시나리오

| TC-ID | 시나리오 | 예상 결과 |
|-------|----------|-----------|
| TC-SHARE-01 | 포트폴리오를 PUBLIC으로 설정 | 누구나 조회 가능 |
| TC-SHARE-02 | LINK_ONLY 설정 후 공유 링크 생성 | 링크를 가진 사용자만 조회 가능 |
| TC-FOLLOW-01 | 사용자 팔로우 | 팔로워/팔로잉 목록에 반영 |
| TC-FOLLOW-02 | Self-follow 시도 | 400 에러 반환 |
| TC-LEADER-01 | 리더보드 조회 | 수익률 기준 정렬된 랭킹 표시 |

---

## 8. 마이그레이션 체크리스트

- [ ] Portfolio 테이블에 `visibility`, `share_token`, `is_primary_for_leaderboard` 컬럼 추가
- [ ] `user_follows` 테이블 생성
- [ ] `leaderboard_ranks` 테이블 생성
- [ ] 기존 Portfolio에 기본값 적용 (visibility=PRIVATE, is_primary_for_leaderboard=false)
- [ ] Celery Beat 스케줄 설정 추가

---

## 9. 참조 문서

- [v1.1.0_design_draft.md](file:///Users/shin/MyDir/MyGit/Alpha-Sam/.agent/project/artifacts/architecture/v1.1.0_design_draft.md): 설계 초안
- [domain_rules.md](file:///Users/shin/MyDir/MyGit/Alpha-Sam/.agent/project/info/domain_rules.md): 도메인 규칙
- [tech_stack.md](file:///Users/shin/MyDir/MyGit/Alpha-Sam/.agent/project/info/tech_stack.md): 기술 스택
- [milestones.md](file:///Users/shin/MyDir/MyGit/Alpha-Sam/.agent/project/artifacts/milestone/milestones.md): 마일스톤
