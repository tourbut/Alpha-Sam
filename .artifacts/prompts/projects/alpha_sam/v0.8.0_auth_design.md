# Architecture Design: v0.8.0 Auth System

## 1. 개요
v0.8.0 프로젝트는 기존 `X-User-Id` 헤더 기반의 시뮬레이션 인증에서 벗어나, `FastAPI-Users`와 `JWT`를 활용한 정식 인증 및 권한 관리 시스템으로의 전환을 목표로 합니다.

## 2. 기술 스택
- **Framework**: FastAPI
- **Library**: FastAPI-Users (SQLAlchemy/SQLModel adapter)
- **Authentication**: JWT (JSON Web Token)
- **Token Storage**: Browser LocalStorage / HTTP-only Cookie (추후 결정)
- **Database**: PostgreSQL (SQLModel ORM)

## 3. 상세 아키텍처

### 3.1 모델 변경
기존 `User` 모델을 `FastAPI-Users`의 `SQLAlchemyBaseUserTable` 또는 `SQLModel` 호환 방식으로 마이그레이션합니다.

```python
# app/src/models/user.py (예시)
from fastapi_users_db_sqlmodel import SQLModelBaseUserDB

class User(SQLModelBaseUserDB, table=True):
    __tablename__ = "users"
    nickname: Optional[str] = Field(default=None, max_length=50)
    # email, hashed_password, is_active, is_superuser 등은 상속받음
```

### 3.2 인증 컴포넌트
- **UserManager**: 사용자 등록 시 `NotificationSettings` 자동 생성 로직 포함.
- **Authentication Backend**: `JWTStrategy` 사용. 비밀 키는 `SECRET_KEY` 환경 변수 사용.
- **Transport**: `Bearer` 토큰 방식 사용 (Swagger UI 연동 용이성).

### 3.3 API 엔드포인트
`/api/v1/auth/` 경로 하위에 다음 기능 추가:
- `/register`: 회원가입
- `/login`: 로그인 (JWT 발행)
- `/logout`: 로그아웃
- `/forgot-password`: 비밀번호 재설정 (Email 연동)
- `/me`: 현재 사용자 정보 조회

## 4. 이관 경로 (Migration Path)

### Phase 1: 하이브리드 모드 (v0.8.0-rc1)
- `deps.py`의 `get_current_user`가 JWT와 `X-User-Id`를 동시에 지원하되, 로그를 통해 시뮬레이션 헤더 사용 시 경고 노출.
- 프론트엔드에서 로그인 flow 구현 및 JWT 저장 처리.

### Phase 2: 시뮬레이션 제거 (v0.8.0-final)
- `X-User-Id` 헤더 처리 로직 완전 제거.
- 모든 API는 유효한 JWT 토큰을 필수로 함.

## 5. 보안 고려사항
- **Password Hashing**: `bcrypt` 또는 `argon2` 사용.
- **Token Expiry**: Access Token (30분), Refresh Token (7일 - Redis 서버 측 블랙리스트 또는 데이터베이스 관리).
- **CORS**: 허용된 도메인에서만 토큰 전송 가능하도록 설정.
